name: CI

on:
  push:
    branches: [ main, develop ]
    tags:
      - "v*"
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read
  security-events: write

env:
  GO_VERSION: ${{ vars.GO_VERSION || 'latest' }}
  FORCE_ALL_LIBRARIES: ${{ vars.FORCE_ALL_LIBRARIES || 'false' }}
  GOLANGCI_LINT_VERSION: ${{ vars.GOLANGCI_LINT_VERSION || 'latest' }}
  GOSEC_VERSION: ${{ vars.GOSEC_VERSION|| 'latest' }}

jobs:
  changes:
    name: Detectar cambios
    runs-on: ${{ vars.CI_RUNNER || 'latest' }}
    outputs:
      any_changed: ${{ steps.detect.outputs.any_changed }}
      changed_json: ${{ steps.detect.outputs.changed_json }}
      changed_csv: ${{ steps.detect.outputs.changed_csv }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detectar librerias con cambios
        id: detect
        shell: bash
        run: |
          set -euo pipefail

          LIBRARIES=(apikey audit authz errors middleware migrate nats swagger testhelpers)

          if [[ "${FORCE_ALL_LIBRARIES:-false}" == "true" ]]; then
            CHANGED_CSV="$(IFS=,; echo "${LIBRARIES[*]}")"
            CHANGED_JSON="[\"apikey\",\"audit\",\"authz\",\"errors\",\"middleware\",\"migrate\",\"nats\",\"swagger\",\"testhelpers\"]"
            echo "any_changed=true" >> "$GITHUB_OUTPUT"
            echo "changed_csv=${CHANGED_CSV}" >> "$GITHUB_OUTPUT"
            echo "changed_json=${CHANGED_JSON}" >> "$GITHUB_OUTPUT"
            echo "FORCE_ALL_LIBRARIES=true -> ejecutando CI para todas las librerias"
            exit 0
          fi

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi

          if [[ -z "${BASE_SHA}" || "${BASE_SHA}" == "0000000000000000000000000000000000000000" ]]; then
            BASE_SHA="$(git rev-list --max-parents=0 HEAD | tail -n 1)"
          fi

          CHANGED_FILES="$(git diff --name-only "${BASE_SHA}" "${HEAD_SHA}" || true)"

          changed=()
          for lib in "${LIBRARIES[@]}"; do
            if echo "${CHANGED_FILES}" | grep -q "^${lib}/"; then
              changed+=("${lib}")
            fi
          done

          if [[ ${#changed[@]} -eq 0 ]]; then
            echo "any_changed=false" >> "$GITHUB_OUTPUT"
            echo "changed_csv=" >> "$GITHUB_OUTPUT"
            echo "changed_json=[]" >> "$GITHUB_OUTPUT"
            echo "No se detectaron cambios en librerias."
            exit 0
          fi

          CHANGED_CSV="$(IFS=,; echo "${changed[*]}")"
          CHANGED_JSON="["
          for i in "${!changed[@]}"; do
            if [[ $i -gt 0 ]]; then
              CHANGED_JSON+="," 
            fi
            CHANGED_JSON+="\"${changed[$i]}\""
          done
          CHANGED_JSON+="]"

          echo "any_changed=true" >> "$GITHUB_OUTPUT"
          echo "changed_csv=${CHANGED_CSV}" >> "$GITHUB_OUTPUT"
          echo "changed_json=${CHANGED_JSON}" >> "$GITHUB_OUTPUT"
          echo "Librerias con cambios: ${CHANGED_CSV}"

  no-changes:
    name: Sin cambios en librerias
    needs: [changes]
    if: ${{ needs.changes.outputs.any_changed != 'true' }}
    runs-on: ${{ vars.CI_RUNNER || 'latest' }}
    steps:
      - name: Omitir CI de librerias
        run: echo "No se detectaron cambios en modulos de Connect-Libraries; se omiten jobs de lint/test/seguridad."

  lint:
    name: Lint
    needs: [changes]
    if: ${{ needs.changes.outputs.any_changed == 'true' }}
    runs-on: ${{ vars.CI_RUNNER || 'latest' }}
    strategy:
      matrix:
        library: ${{ fromJson(needs.changes.outputs.changed_json) }}
    steps:
    - uses: actions/checkout@v4
    
    - name: Configurar Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
        cache-dependency-path: ${{ matrix.library }}/go.sum

    - name: Descargar dependencias
      working-directory: ./${{ matrix.library }}
      run: go mod download

    - name: Verificar dependencias
      working-directory: ./${{ matrix.library }}
      run: go mod verify
    
    - name: golangci-lint
      uses: golangci/golangci-lint-action@v7
      with:
        version: ${{ env.GOLANGCI_LINT_VERSION }}
        working-directory: ${{ matrix.library }}
        args: --timeout=5m

  test:
    name: Pruebas
    needs: [changes]
    if: ${{ needs.changes.outputs.any_changed == 'true' }}
    runs-on: ${{ vars.CI_RUNNER || 'latest' }}
    strategy:
      matrix:
        library: ${{ fromJson(needs.changes.outputs.changed_json) }}

    steps:
    - uses: actions/checkout@v4
    
    - name: Configurar Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
        cache-dependency-path: ${{ matrix.library }}/go.sum
    
    - name: Descargar dependencias
      working-directory: ./${{ matrix.library }}
      run: go mod download
    
    - name: Verificar dependencias
      working-directory: ./${{ matrix.library }}
      run: go mod verify
    
    - name: Ejecutar pruebas
      working-directory: ./${{ matrix.library }}
      run: go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...

  security-gosec:
    name: Seguridad Gosec
    needs: [changes]
    if: ${{ needs.changes.outputs.any_changed == 'true' }}
    runs-on: ${{ vars.CI_RUNNER || 'latest' }}
    strategy:
      matrix:
        library: ${{ fromJson(needs.changes.outputs.changed_json) }}
    steps:
    - uses: actions/checkout@v4
    
    - name: Configurar Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
        cache-dependency-path: ${{ matrix.library }}/go.sum

    - name: Descargar dependencias
      working-directory: ./${{ matrix.library }}
      run: go mod download

    - name: Verificar dependencias
      working-directory: ./${{ matrix.library }}
      run: go mod verify

    - name: Instalar gosec
      run: go install github.com/securego/gosec/v2/cmd/gosec@${{ env.GOSEC_VERSION }}

    - name: Ejecutar escaner de seguridad Gosec
      working-directory: ./${{ matrix.library }}
      run: gosec ./...

  security-trivy:
    name: Seguridad Trivy
    needs: [changes]
    if: ${{ needs.changes.outputs.any_changed == 'true' }}
    runs-on: ${{ vars.CI_RUNNER || 'latest' }}
    steps:
    - uses: actions/checkout@v4
    
    - name: Ejecutar escaner de vulnerabilidades Trivy
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Subir resultados de Trivy a GitHub Security
      if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: 'trivy-results.sarif'

  summary:
    name: Resumen de CI
    if: ${{ always() }}
    runs-on: ${{ vars.CI_RUNNER || 'latest' }}
    needs: [changes, no-changes, lint, test, security-gosec, security-trivy]
    steps:
      - name: Imprimir resumen
        shell: bash
        run: |
          echo "=== Resumen de CI de Connect-Libraries ==="
          echo "any_changed: ${{ needs.changes.outputs.any_changed }}"
          echo "changed_libraries: ${{ needs.changes.outputs.changed_csv }}"
          echo "no-changes: ${{ needs.no-changes.result }}"
          echo "lint: ${{ needs.lint.result }}"
          echo "test: ${{ needs.test.result }}"
          echo "security-gosec: ${{ needs.security-gosec.result }}"
          echo "security-trivy: ${{ needs.security-trivy.result }}"