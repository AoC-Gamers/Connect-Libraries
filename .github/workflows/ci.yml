name: CI

on:
  push:
    branches: [ main, develop ]
    tags:
      - "v*"
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.24'

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      any_changed: ${{ steps.detect.outputs.any_changed }}
      changed_json: ${{ steps.detect.outputs.changed_json }}
      changed_csv: ${{ steps.detect.outputs.changed_csv }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed libraries
        id: detect
        shell: bash
        run: |
          set -euo pipefail

          LIBRARIES=(apikey audit authz errors middleware migrate nats swagger testhelpers)

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi

          if [[ -z "${BASE_SHA}" || "${BASE_SHA}" == "0000000000000000000000000000000000000000" ]]; then
            BASE_SHA="$(git rev-list --max-parents=0 HEAD | tail -n 1)"
          fi

          CHANGED_FILES="$(git diff --name-only "${BASE_SHA}" "${HEAD_SHA}" || true)"

          changed=()
          for lib in "${LIBRARIES[@]}"; do
            if echo "${CHANGED_FILES}" | grep -q "^${lib}/"; then
              changed+=("${lib}")
            fi
          done

          if [[ ${#changed[@]} -eq 0 ]]; then
            echo "any_changed=false" >> "$GITHUB_OUTPUT"
            echo "changed_csv=" >> "$GITHUB_OUTPUT"
            echo "changed_json=[]" >> "$GITHUB_OUTPUT"
            echo "No library changes detected."
            exit 0
          fi

          CHANGED_CSV="$(IFS=,; echo "${changed[*]}")"
          CHANGED_JSON="["
          for i in "${!changed[@]}"; do
            if [[ $i -gt 0 ]]; then
              CHANGED_JSON+="," 
            fi
            CHANGED_JSON+="\"${changed[$i]}\""
          done
          CHANGED_JSON+="]"

          echo "any_changed=true" >> "$GITHUB_OUTPUT"
          echo "changed_csv=${CHANGED_CSV}" >> "$GITHUB_OUTPUT"
          echo "changed_json=${CHANGED_JSON}" >> "$GITHUB_OUTPUT"
          echo "Changed libraries: ${CHANGED_CSV}"

  no-changes:
    name: No Library Changes
    needs: [changes]
    if: ${{ needs.changes.outputs.any_changed != 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Skip library CI
        run: echo "No changes detected in Connect-Libraries modules; skipping lint/test/security jobs."

  lint:
    name: Lint
    needs: [changes]
    if: ${{ needs.changes.outputs.any_changed == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        library: ${{ fromJson(needs.changes.outputs.changed_json) }}
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
        cache-dependency-path: ${{ matrix.library }}/go.sum

    - name: Download dependencies
      working-directory: ./${{ matrix.library }}
      run: go mod download

    - name: Verify dependencies
      working-directory: ./${{ matrix.library }}
      run: go mod verify
    
    - name: golangci-lint
      uses: golangci/golangci-lint-action@v6
      with:
        version: v2.10.1
        working-directory: ${{ matrix.library }}
        args: --timeout=5m

  test:
    name: Test
    needs: [changes]
    if: ${{ needs.changes.outputs.any_changed == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        library: ${{ fromJson(needs.changes.outputs.changed_json) }}

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
        cache-dependency-path: ${{ matrix.library }}/go.sum
    
    - name: Download dependencies
      working-directory: ./${{ matrix.library }}
      run: go mod download
    
    - name: Verify dependencies
      working-directory: ./${{ matrix.library }}
      run: go mod verify
    
    - name: Run tests
      working-directory: ./${{ matrix.library }}
      run: go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...

  security-gosec:
    name: Security Gosec
    needs: [changes]
    if: ${{ needs.changes.outputs.any_changed == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        library: ${{ fromJson(needs.changes.outputs.changed_json) }}
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
        cache-dependency-path: ${{ matrix.library }}/go.sum

    - name: Run Gosec Security Scanner
      uses: securego/gosec@master
      with:
        args: './${{ matrix.library }}/...'

  security-trivy:
    name: Security Trivy
    needs: [changes]
    if: ${{ needs.changes.outputs.any_changed == 'true' }}
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'

  summary:
    name: CI Summary
    if: ${{ always() }}
    runs-on: ubuntu-latest
    needs: [changes, no-changes, lint, test, security-gosec, security-trivy]
    steps:
      - name: Print summary
        shell: bash
        run: |
          echo "=== Connect-Libraries CI Summary ==="
          echo "any_changed: ${{ needs.changes.outputs.any_changed }}"
          echo "changed_libraries: ${{ needs.changes.outputs.changed_csv }}"
          echo "no-changes: ${{ needs.no-changes.result }}"
          echo "lint: ${{ needs.lint.result }}"
          echo "test: ${{ needs.test.result }}"
          echo "security-gosec: ${{ needs.security-gosec.result }}"
          echo "security-trivy: ${{ needs.security-trivy.result }}"