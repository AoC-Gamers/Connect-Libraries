name: CI

on:
  push:
    branches: [ main, develop ]
    tags:
      - "v*"
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read
  security-events: write

env:
  FORCE_ALL_LIBRARIES: ${{ vars.FORCE_ALL_LIBRARIES || 'false' }}

jobs:
  changes:
    name: Detectar cambios
    runs-on: ${{ vars.CI_RUNNER || 'latest' }}
    outputs:
      any_changed: ${{ steps.detect.outputs.any_changed }}
      changed_json: ${{ steps.detect.outputs.changed_json }}
      changed_csv: ${{ steps.detect.outputs.changed_csv }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detectar librerias con cambios
        id: detect
        shell: bash
        run: |
          set -euo pipefail

          LIBRARIES=(apikey audit authz errors middleware migrate nats swagger testhelpers)

          if [[ "${FORCE_ALL_LIBRARIES:-false}" == "true" ]]; then
            CHANGED_CSV="$(IFS=,; echo "${LIBRARIES[*]}")"
            CHANGED_JSON="[\"apikey\",\"audit\",\"authz\",\"errors\",\"middleware\",\"migrate\",\"nats\",\"swagger\",\"testhelpers\"]"
            echo "any_changed=true" >> "$GITHUB_OUTPUT"
            echo "changed_csv=${CHANGED_CSV}" >> "$GITHUB_OUTPUT"
            echo "changed_json=${CHANGED_JSON}" >> "$GITHUB_OUTPUT"
            echo "FORCE_ALL_LIBRARIES=true -> ejecutando CI para todas las librerias"
            exit 0
          fi

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi

          if [[ -z "${BASE_SHA}" || "${BASE_SHA}" == "0000000000000000000000000000000000000000" ]]; then
            BASE_SHA="$(git rev-list --max-parents=0 HEAD | tail -n 1)"
          fi

          CHANGED_FILES="$(git diff --name-only "${BASE_SHA}" "${HEAD_SHA}" || true)"

          changed=()
          for lib in "${LIBRARIES[@]}"; do
            if echo "${CHANGED_FILES}" | grep -q "^${lib}/"; then
              changed+=("${lib}")
            fi
          done

          if [[ ${#changed[@]} -eq 0 ]]; then
            echo "any_changed=false" >> "$GITHUB_OUTPUT"
            echo "changed_csv=" >> "$GITHUB_OUTPUT"
            echo "changed_json=[]" >> "$GITHUB_OUTPUT"
            echo "No se detectaron cambios en librerias."
            exit 0
          fi

          CHANGED_CSV="$(IFS=,; echo "${changed[*]}")"
          CHANGED_JSON="["
          for i in "${!changed[@]}"; do
            if [[ $i -gt 0 ]]; then
              CHANGED_JSON+="," 
            fi
            CHANGED_JSON+="\"${changed[$i]}\""
          done
          CHANGED_JSON+="]"

          echo "any_changed=true" >> "$GITHUB_OUTPUT"
          echo "changed_csv=${CHANGED_CSV}" >> "$GITHUB_OUTPUT"
          echo "changed_json=${CHANGED_JSON}" >> "$GITHUB_OUTPUT"
          echo "Librerias con cambios: ${CHANGED_CSV}"

  no-changes:
    name: Sin cambios en librerias
    needs: [changes]
    if: ${{ needs.changes.outputs.any_changed != 'true' }}
    runs-on: ${{ vars.CI_RUNNER || 'latest' }}
    steps:
      - name: Omitir CI de librerias
        run: echo "No se detectaron cambios en modulos de Connect-Libraries; se omiten jobs de lint/test/seguridad."

  lint:
    name: Lint
    needs: [changes]
    if: ${{ needs.changes.outputs.any_changed == 'true' }}
    runs-on: ${{ vars.CI_RUNNER || 'latest' }}
    strategy:
      matrix:
        library: ${{ fromJson(needs.changes.outputs.changed_json) }}
    steps:
    - uses: actions/checkout@v4
    
    - name: Configurar Go
      uses: actions/setup-go@v5
      with:
        go-version-file: ${{ matrix.library }}/go.mod
        cache: true
        cache-dependency-path: ${{ matrix.library }}/go.sum

    - name: Instalar herramientas de CI
      working-directory: ./${{ matrix.library }}
      run: |
        set -euo pipefail
        export PATH="$(go env GOPATH)/bin:$PATH"
        make install-tools

    - name: Descargar dependencias
      working-directory: ./${{ matrix.library }}
      run: go mod download

    - name: Verificar dependencias
      working-directory: ./${{ matrix.library }}
      run: go mod verify
    
    - name: Lint
      working-directory: ./${{ matrix.library }}
      run: |
        set -euo pipefail
        export PATH="$(go env GOPATH)/bin:$PATH"
        make lint

  test:
    name: Pruebas
    needs: [changes]
    if: ${{ needs.changes.outputs.any_changed == 'true' }}
    runs-on: ${{ vars.CI_RUNNER || 'latest' }}
    strategy:
      matrix:
        library: ${{ fromJson(needs.changes.outputs.changed_json) }}

    steps:
    - uses: actions/checkout@v4
    
    - name: Configurar Go
      uses: actions/setup-go@v5
      with:
        go-version-file: ${{ matrix.library }}/go.mod
        cache: true
        cache-dependency-path: ${{ matrix.library }}/go.sum
    
    - name: Descargar dependencias
      working-directory: ./${{ matrix.library }}
      run: go mod download
    
    - name: Verificar dependencias
      working-directory: ./${{ matrix.library }}
      run: go mod verify
    
    - name: Ejecutar pruebas
      working-directory: ./${{ matrix.library }}
      run: |
        set -euo pipefail
        make test
