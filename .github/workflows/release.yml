name: Release

on:
  push:
    tags:
      - '*/v*.*.*'

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Extract version from tag
      id: tag
      run: |
        TAG="${GITHUB_REF#refs/tags/}"
        LIBRARY="${TAG%%/v*}"
        VERSION="${TAG##*/v}"

        echo "TAG=${TAG}" >> "$GITHUB_OUTPUT"
        echo "LIBRARY=${LIBRARY}" >> "$GITHUB_OUTPUT"
        echo "VERSION=${VERSION}" >> "$GITHUB_OUTPUT"
    
    - name: Extract changelog
      id: changelog
      run: |
        LIBRARY=${{ steps.tag.outputs.LIBRARY }}
        VERSION=${{ steps.tag.outputs.VERSION }}
        CHANGELOG_PATH="${LIBRARY}/CHANGELOG.md"

        echo "Extracting changelog for ${LIBRARY} version ${VERSION}"
        
        if [ ! -f "${CHANGELOG_PATH}" ]; then
          echo "Release ${LIBRARY}/v${VERSION}" > release-notes.md
          echo "" >> release-notes.md
          echo "No CHANGELOG found at ${CHANGELOG_PATH}." >> release-notes.md
          exit 0
        fi

        # Extract section from library CHANGELOG.md
        sed -n "/## \[$VERSION\]/,/## \[/p" "${CHANGELOG_PATH}" | sed '$d' > release-notes.md
        
        # If empty, use generic message
        if [ ! -s release-notes.md ]; then
          echo "Release ${LIBRARY}/v${VERSION}" > release-notes.md
          echo "" >> release-notes.md
          echo "See [${CHANGELOG_PATH}](https://github.com/AoC-Gamers/connect-libraries/blob/main/${CHANGELOG_PATH}) for details." >> release-notes.md
        fi
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.tag.outputs.TAG }}
        name: ${{ steps.tag.outputs.LIBRARY }}/v${{ steps.tag.outputs.VERSION }}
        body_path: release-notes.md
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Notify success
      run: |
        echo "âœ… Release ${{ steps.tag.outputs.LIBRARY }}/v${{ steps.tag.outputs.VERSION }} published successfully"
